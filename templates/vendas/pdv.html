<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV - Sistema PDV</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .produto-card { 
            cursor: pointer; 
            transition: all 0.3s; 
            border: 2px solid transparent;
        }
        .produto-card:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 4px 15px rgba(0,0,0,0.15);
            border-color: #0d6efd;
        }
        .carrinho-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 8px;
            border: 1px solid #e9ecef;
        }
        .produto-unavailable {
            opacity: 0.5;
            pointer-events: none;
        }
        .total-display {
            font-size: 1.8rem;
            font-weight: bold;
            color: #198754;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="/">
                <i class="bi bi-shop"></i> Sistema PDV
            </a>
            <ul class="navbar-nav">
                <li class="nav-item">
                    <a class="nav-link active" href="/vendas/pdv/">PDV</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/produtos/">Produtos</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/clientes/">Clientes</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/admin/">Admin</a>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="row">
            <!-- Área de Produtos -->
            <div class="col-md-8">
                <!-- Busca -->
                <div class="card mb-3">
                    <div class="card-body">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <input type="text" id="searchProduto" class="form-control" 
                                       placeholder="Buscar produto...">
                            </div>
                            <div class="col-md-4">
                                <select id="filtroCategoria" class="form-select">
                                    <option value="">Todas as categorias</option>
                                    {% for categoria in categorias %}
                                    <option value="{{ categoria.id }}">{{ categoria.nome }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Lista de Produtos -->
                <div class="card">
                    <div class="card-header">
                        <h5>Produtos Disponíveis (<span id="contador-produtos">{{ produtos.count }}</span>)</h5>
                    </div>
                    <div class="card-body" style="max-height: 60vh; overflow-y: auto;">
                        <div class="row">
                            {% for produto in produtos %}
                            <div class="col-lg-6 mb-3 produto-item" 
                                 data-nome="{{ produto.nome|lower }}" 
                                 data-codigo="{{ produto.codigo|lower }}"
                                 data-categoria="{{ produto.categoria.id }}"
                                 data-produto-id="{{ produto.id }}"
                                 data-produto-nome="{{ produto.nome }}"
                                 data-produto-preco="{{ produto.preco_venda }}"
                                 data-produto-estoque="{{ produto.estoque_atual }}"
                                 data-produto-codigo="{{ produto.codigo }}">
                                <div class="produto-card card {% if produto.estoque_atual <= 0 %}produto-unavailable{% endif %}">
                                    <div class="card-body">
                                        <h6>{{ produto.nome }}</h6>
                                        <p class="mb-1">
                                            <small class="text-muted">{{ produto.codigo }}</small><br>
                                            <span class="text-success fw-bold">R$ {{ produto.preco_venda }}</span><br>
                                            <small>Estoque: {{ produto.estoque_atual }}</small>
                                        </p>
                                    </div>
                                </div>
                            </div>
                            {% empty %}
                            <div class="col-12 text-center py-5">
                                <h5>Nenhum produto encontrado</h5>
                                <a href="{% url 'produtos:criar' %}" class="btn btn-primary">Cadastrar Produtos</a>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Carrinho -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">Carrinho</h5>
                    </div>
                    <div class="card-body">
                        <!-- Cliente -->
                        <div class="mb-3">
                            <label class="form-label">Cliente</label>
                            <select class="form-select" id="cliente-select">
                                <option value="">Cliente não informado</option>
                                {% for cliente in clientes %}
                                <option value="{{ cliente.id }}">{{ cliente.nome }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Itens -->
                        <div class="mb-3" style="min-height: 200px;" id="carrinho-itens">
                            <div class="text-center text-muted py-4" id="carrinho-vazio">
                                <p>Carrinho vazio</p>
                                <small>Clique nos produtos para adicionar</small>
                            </div>
                        </div>

                        <!-- Totais -->
                        <div class="border-top pt-3">
                            <div class="d-flex justify-content-between mb-2">
                                <span>Itens:</span>
                                <span id="total-itens">0</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Subtotal:</span>
                                <span id="subtotal">R$ 0,00</span>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Desconto:</label>
                                <input type="number" class="form-control" id="desconto" 
                                       value="0" step="0.01" min="0">
                            </div>
                            <div class="d-flex justify-content-between mb-3">
                                <strong>Total:</strong>
                                <strong class="total-display" id="total">R$ 0,00</strong>
                            </div>

                            <!-- Pagamento -->
                            <div class="mb-3">
                                <label class="form-label">Pagamento</label>
                                <select class="form-select" id="forma-pagamento">
                                    <option value="D">Dinheiro</option>
                                    <option value="C">Cartão de Crédito</option>
                                    <option value="B">Cartão de Débito</option>
                                    <option value="P">PIX</option>
                                </select>
                            </div>

                            <!-- Botão -->
                            <button class="btn btn-success w-100" id="btn-finalizar" disabled>
                                Finalizar Venda
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        var carrinho = [];

        function adicionarProduto(id, nome, preco, estoque, codigo) {
            if (estoque <= 0) {
                alert('Produto sem estoque!');
                return;
            }

            var item = null;
            var i = 0;
            for (i = 0; i < carrinho.length; i = i + 1) {
                if (carrinho[i].id == id) {
                    item = carrinho[i];
                    break;
                }
            }
            
            if (item) {
                if (item.quantidade < estoque) {
                    item.quantidade = item.quantidade + 1;
                    item.subtotal = item.quantidade * item.preco;
                } else {
                    alert('Quantidade máxima atingida!');
                    return;
                }
            } else {
                carrinho.push({
                    id: id,
                    nome: nome,
                    codigo: codigo,
                    preco: parseFloat(preco),
                    quantidade: 1,
                    subtotal: parseFloat(preco),
                    estoque: estoque
                });
            }

            atualizarCarrinho();
        }

        function removerItem(id) {
            var novo = [];
            var i = 0;
            for (i = 0; i < carrinho.length; i = i + 1) {
                if (carrinho[i].id != id) {
                    novo.push(carrinho[i]);
                }
            }
            carrinho = novo;
            atualizarCarrinho();
        }

        function atualizarCarrinho() {
            var container = document.getElementById('carrinho-itens');
            var vazio = document.getElementById('carrinho-vazio');
            
            if (carrinho.length == 0) {
                vazio.style.display = 'block';
                document.getElementById('btn-finalizar').disabled = true;
            } else {
                vazio.style.display = 'none';
                document.getElementById('btn-finalizar').disabled = false;
                
                var html = '';
                var i = 0;
                var item = null;
                for (i = 0; i < carrinho.length; i = i + 1) {
                    item = carrinho[i];
                    html = html + '<div class="carrinho-item">';
                    html = html + '<div class="d-flex justify-content-between">';
                    html = html + '<div><strong>' + item.nome + '</strong><br>';
                    html = html + '<small>' + item.codigo + '</small></div>';
                    html = html + '<button class="btn btn-sm btn-danger" data-remove-id="' + item.id + '">X</button>';
                    html = html + '</div>';
                    html = html + '<div class="d-flex justify-content-between mt-2">';
                    html = html + '<span>Qtd: ' + item.quantidade + '</span>';
                    html = html + '<strong>R$ ' + item.subtotal.toFixed(2) + '</strong>';
                    html = html + '</div></div>';
                }
                
                container.innerHTML = vazio.outerHTML + html;
                
                // Adicionar event listeners para botões de remover
                var botoes = document.querySelectorAll('[data-remove-id]');
                var j = 0;
                for (j = 0; j < botoes.length; j = j + 1) {
                    botoes[j].onclick = function() {
                        var id = parseInt(this.getAttribute('data-remove-id'));
                        removerItem(id);
                    };
                }
            }
            
            calcularTotal();
        }

        function calcularTotal() {
            var subtotal = 0;
            var totalItens = 0;
            var i = 0;
            
            for (i = 0; i < carrinho.length; i = i + 1) {
                subtotal = subtotal + carrinho[i].subtotal;
                totalItens = totalItens + carrinho[i].quantidade;
            }
            
            var desconto = parseFloat(document.getElementById('desconto').value) || 0;
            var total = Math.max(0, subtotal - desconto);
            
            document.getElementById('total-itens').innerHTML = totalItens;
            document.getElementById('subtotal').innerHTML = 'R$ ' + subtotal.toFixed(2);
            document.getElementById('total').innerHTML = 'R$ ' + total.toFixed(2);
        }

        function finalizarVenda() {
            if (carrinho.length == 0) {
                alert('Carrinho vazio!');
                return;
            }

            var total = 0;
            var i = 0;
            for (i = 0; i < carrinho.length; i = i + 1) {
                total = total + carrinho[i].subtotal;
            }
            
            var desconto = parseFloat(document.getElementById('desconto').value) || 0;
            total = total - desconto;
            
            if (confirm('Confirmar venda de R$ ' + total.toFixed(2) + '?')) {
                alert('Venda realizada!');
                carrinho = [];
                atualizarCarrinho();
                document.getElementById('cliente-select').value = '';
                document.getElementById('desconto').value = '0';
            }
        }

        function filtrarProdutos() {
            var busca = document.getElementById('searchProduto').value.toLowerCase();
            var categoria = document.getElementById('filtroCategoria').value;
            var itens = document.querySelectorAll('.produto-item');
            var contador = 0;
            var i = 0;
            var item = null;
            var nome = '';
            var codigo = '';
            var cat = '';
            var matchBusca = false;
            var matchCat = false;

            for (i = 0; i < itens.length; i = i + 1) {
                item = itens[i];
                nome = item.getAttribute('data-nome');
                codigo = item.getAttribute('data-codigo');
                cat = item.getAttribute('data-categoria');
                
                matchBusca = nome.indexOf(busca) >= 0 || codigo.indexOf(busca) >= 0;
                matchCat = !categoria || cat == categoria;
                
                if (matchBusca && matchCat) {
                    item.style.display = 'block';
                    contador = contador + 1;
                } else {
                    item.style.display = 'none';
                }
            }

            document.getElementById('contador-produtos').innerHTML = contador;
        }

        // Event listeners
        window.onload = function() {
            // Busca
            document.getElementById('searchProduto').onkeyup = filtrarProdutos;
            document.getElementById('filtroCategoria').onchange = filtrarProdutos;
            document.getElementById('desconto').onchange = calcularTotal;
            document.getElementById('btn-finalizar').onclick = finalizarVenda;
            
            // Produtos
            var produtos = document.querySelectorAll('.produto-card');
            var i = 0;
            for (i = 0; i < produtos.length; i = i + 1) {
                produtos[i].onclick = function() {
                    var container = this.parentNode;
                    var id = parseInt(container.getAttribute('data-produto-id'));
                    var nome = container.getAttribute('data-produto-nome');
                    var preco = parseFloat(container.getAttribute('data-produto-preco'));
                    var estoque = parseInt(container.getAttribute('data-produto-estoque'));
                    var codigo = container.getAttribute('data-produto-codigo');
                    
                    adicionarProduto(id, nome, preco, estoque, codigo);
                };
            }
        };
    </script>
</body>
</html>